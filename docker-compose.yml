version: '3.8'
services:
  # === æ‚¨çš„ Java App (å»ºè­°åœ¨é–‹ç™¼ K8s æ™‚è¨»è§£æ‰) ===
  # å¦‚æœè¦è·‘ K8s æˆ– IntelliJï¼Œè«‹æŠŠé€™æ®µè¨»è§£æ‰ï¼Œé¿å… Port 8080 è¡çª
  # flash-sale-app:
  #   build: .
  #   container_name: flash-sale-app
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker
  #   depends_on:
  #     - mysql
  #     - redis
  #     - zookeeper
  #     - kafka
  #     - mongodb
  #   networks:
  #     - flash-sale-net

  # === åŸºç¤è¨­æ–½ ===
  mysql:
    image: mysql:8.0
    container_name: demo-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: flash_sale_db
    ports:
      - "3306:3306"
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      # ğŸ‘‡ ä¿®æ”¹é€™è£¡ï¼šæ ¼å¼ç‚º "æœ¬æ©Ÿè·¯å¾‘:å®¹å™¨å…§è·¯å¾‘"
      # å»ºè­°å¯«æ³• (ä½¿ç”¨ / é¿å…éŒ¯èª¤)
      - C:/source/mysql-data:/var/lib/mysql

      # æˆ–è€…ï¼Œå¦‚æœæ‚¨ docker-compose.yml å°±åœ¨ C:\source ä¸‹ï¼Œç”¨ç›¸å°è·¯å¾‘æœ€ç©©ï¼š
      # - ./mysql-data:/var/lib/mysql
    networks:
      - flash-sale-net

  redis:
    image: redis:7.0
    container_name: demo-redis
    ports:
      - "6379:6379"
    networks:
      - flash-sale-net

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: demo-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - flash-sale-net

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: demo-kafka
    ports:
      - "9092:9092" # çµ¦ IntelliJ (localhost)
      - "9093:9093" # çµ¦ K8s (host.docker.internal)
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181

      # ğŸ”¥ é—œéµä¿®æ”¹ï¼šå®šç¾©ä¸‰å€‹ç›£è½å™¨
      # 1. INTERNAL (29092): Docker å…§éƒ¨æºé€š (Controller æºé€š)
      # 2. LOCALHOST (9092): çµ¦æœ¬æ©Ÿ IntelliJ é–‹ç™¼ç”¨
      # 3. EXTERNAL (9093): çµ¦ K8s Pod ç”¨

      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,LOCALHOST:PLAINTEXT,EXTERNAL:PLAINTEXT

      # é–‹æ”¾ä¸‰å€‹ Port
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:29092,LOCALHOST://0.0.0.0:9092,EXTERNAL://0.0.0.0:9093

      # å°å¤–å»£æ’­åœ°å€ (åˆ¥äººè¦æ€éº¼æ‰¾åˆ°æˆ‘)
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,LOCALHOST://localhost:9092,EXTERNAL://host.docker.internal:9093

      # å…§éƒ¨é€šè¨Šèµ° INTERNAL é€šé“
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    networks:
      - flash-sale-net

  mongodb:
    image: mongo:6.0
    container_name: demo-mongodb
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    volumes:
      # ğŸ‘‡ MongoDB å»ºè­°ï¼šæ˜ å°„å‡ºä¾†ï¼Œé€™æ¨£å®¹å™¨æ­»æ‰é‚„èƒ½æŸ¥ Log
      - C:/source/mongo-data:/data/db
    networks:
      - flash-sale-net

volumes:
  mongo_data:
  mysql_data: # é…åˆä¸Šé¢çš„ MySQL volume

networks:
  flash-sale-net:
    driver: bridge