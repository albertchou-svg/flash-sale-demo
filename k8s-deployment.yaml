apiVersion: apps/v1
kind: Deployment
metadata:
  name: flash-sale-app
spec:
  replicas: 3 # ğŸ”¥ é‡é»ï¼šç›´æ¥é–‹å•Ÿ 3 å€‹å¯¦ä¾‹ï¼Œé«”é©— K8s çš„å¨åŠ›
  selector:
    matchLabels:
      app: flash-sale
  template:
    metadata:
      labels:
        app: flash-sale
    spec:
      containers:
        - name: flash-sale-app
          image: flash-sale-app:k8s-v1 # å°æ‡‰å‰›æ‰ build çš„ Tag
          imagePullPolicy: Never # ğŸ”¥ é—œéµï¼šå¼·åˆ¶ä½¿ç”¨æœ¬æ©Ÿ Imageï¼Œä¸å»ç¶²è·¯ä¸‹è¼‰
          ports:
            - containerPort: 8080

          # ğŸ‘‡ é€™è£¡å°±æ˜¯ã€Œæ··åˆæ¶æ§‹ã€çš„ç²¾é«“ï¼šç’°å¢ƒè®Šæ•¸è¦†è“‹æ³•
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "docker" # æ²¿ç”¨ docker profile çš„é‚è¼¯

            # è¦†è“‹ MySQL é€£ç·š (é€£å›æœ¬æ©Ÿ)
            - name: SPRING_DATASOURCE_URL
              value: "jdbc:mysql://host.docker.internal:3306/flash_sale_db?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true"

            # è¦†è“‹ Redis é€£ç·š
            - name: SPRING_DATA_REDIS_HOST
              value: "host.docker.internal"

            # è¦†è“‹ MongoDB é€£ç·š
            - name: SPRING_DATA_MONGODB_URI
              value: "mongodb://root:root@host.docker.internal:27017/flash_sale_logs?authSource=admin"

            # è¦†è“‹ Kafka é€£ç·š (æ³¨æ„ï¼šKafka çš„è¨­å®šæ¯”è¼ƒæ•æ„Ÿï¼Œé€™è£¡é€£æœ¬æ©Ÿçš„ 9093 å¤–éƒ¨ Port)
            - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
              value: "host.docker.internal:9093"

            # è¦†è“‹ Zookeeper é€£ç·š
            - name: ZOOKEEPER_ADDRESS
              value: "host.docker.internal:2181"

---
# å®šç¾© Service è®“å¤–éƒ¨å¯ä»¥é€£ç·š
apiVersion: v1
kind: Service
metadata:
  name: flash-sale-service
spec:
  type: LoadBalancer # åœ¨ Docker Desktop æœƒè‡ªå‹•æ˜ å°„åˆ° localhost
  selector:
    app: flash-sale
  ports:
    - protocol: TCP
      port: 80      # å¤–éƒ¨å­˜å–çš„ Port (ç€è¦½å™¨æ‰“ localhost:80)
      targetPort: 8080 # è½‰ç™¼åˆ°å®¹å™¨å…§çš„ 8080